{% extends "base.html" %}
{% block content %}
  <div class="container">
    <div class="row pt-3 pb-1 ml-auto mr-auto">
      <div class="col-sm-9">
        <h2 class="text-muted">{{ report.name }}</h2>
      </div>
      <div class="col-sm-3 text-right">
        <button type="button" onclick="openNav()" class="btn btn-primary btn-circle">
          <i class="fas fa-info"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="container pb-3">
    {% include "_tableau_iframe.html" %}
  </div>

  {% include "_sidepanel.html" %}

{% endblock %}

{% block scripts %}
  <script type='text/javascript' src='https://stg-tableau.kipp.org/javascripts/api/viz_v1.js'></script>
  <script>
    /* Set the width of the side navigation to 250px */
    function openNav() {
      document.getElementById("side-panel").style.width = "35%";
    }

    /* Set the width of the side navigation to 0 */
    function closeNav() {
      document.getElementById("side-panel").style.width = "0";
    }
  </script>
  <script>
      $('.feedback-btn').click(function(){
        $('.sentiment-icon').removeClass('fas').addClass('far');
        commentLabel = $('label[for="comments"]');
        commentLabel.show();
        $('#comments').show();
        $(this).find('i.far').removeClass('far').addClass('fas');
        score = $(this).find('[name="score"]').val();
        if(score > 3){
          commentLabel.text("What do you like about this report?");
        } else if(score < 3){
          commentLabel.text("How could this report be better?");
        } else {
          commentLabel.text("Optional comments:");
        }
      });


      $('#feedbackform').submit(function(event){
        event.preventDefault();
        $.ajax({
          data: $(this).serialize(),
          type: $(this).attr('method'),
          url: $(this).attr('action'),
          success: function(response){
            if(response['success']){
              $('#feedbackform')[0].reset();
              $('.feedback-btn').removeClass('text-success text-danger text-warning');
              $('.alert').prepend("<strong>Success</strong> Thanks for giving your feedback!");
              $('.alert').toggleClass('alert-info');
              $('.alert').removeAttr('hidden');
              $('.collapse').collapse('hide');
              $('.fa-comment').removeClass('far').addClass('fas');
              $('.score-badge').text(response['score']);
              $('.score-badge').removeAttr('hidden');
              $('.avg-feedback').text(response['avg_feedback']);
            }
            if(response['error']){
              $('.alert').prepend("<strong>Error</strong> Something went wrong.");
              $('.alert').toggleClass('alert-danger');
              $('.alert').removeAttr('hidden');
            }
          },
          error: function(request, status, error){
              $('.alert').prepend("<strong>Error</strong> "+error);
              $('.alert').toggleClass('alert-danger');
              $('.alert').removeAttr('hidden');
          }
        });
      });
  </script>
{% endblock %}
